@model TreasuryDashboardDTO
@{
    ViewData["Title"] = "Kasa ve Banka Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var startVal = Context.Request.Query["startDate"].ToString();
    var endVal = Context.Request.Query["endDate"].ToString();
}

<div class="row mb-3">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success shadow-sm">
            <div class="inner">
                <h3>@Model.Treasury.CashBalance.ToString("C2")</h3>
                <p>Nakit Kasa (Elden)</p>
            </div>
            <div class="icon"><i class="fas fa-wallet"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info shadow-sm">
            <div class="inner">
                <h3>@Model.Treasury.BankBalance.ToString("C2")</h3>
                <p>Toplam Banka Varlığı</p>
            </div>
            <div class="icon"><i class="fas fa-university"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning shadow-sm">
            <div class="inner text-white">
                <h3 class="text-white">@Model.Treasury.ReceivablesBalance.ToString("C2")</h3>
                <p>Toplam Alacak (Veresiye)</p>
            </div>
            <div class="icon"><i class="fas fa-book-open"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-secondary shadow-sm">
            <div class="inner">
                <h3>@((Model.Treasury.CashBalance + Model.Treasury.BankBalance).ToString("C2"))</h3>
                <p>Toplam Hazır Değer</p>
            </div>
            <div class="icon"><i class="fas fa-chart-pie"></i></div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-end align-items-center">
       
        <button type="button" class="btn btn-danger btn-lg shadow rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#expenseModal">
            <i class="fas fa-minus-circle mr-2"></i> Gider/Harcama Ekle
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card card-primary card-outline shadow-sm h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-university mr-1"></i> Banka Hesapları</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool bg-primary text-white btn-sm" data-bs-toggle="modal" data-bs-target="#modalAddBank">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0 table-responsive" style="max-height: 300px;">
                <table class="table table-striped table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Banka</th>
                            <th>IBAN</th>
                            <th class="text-right">Bakiye</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bank in Model.Banks)
                        {
                            <tr>
                                <td class="align-middle fw-bold text-primary">@bank.BankName</td>
                                <td class="align-middle"><small class="text-muted">@bank.Iban</small></td>
                                <td class="align-middle text-right font-weight-bold">@bank.Balance.ToString("C2")</td>
                                <td class="align-middle text-right">
                                    <div class="btn-group">
                                        <a asp-action="BankTransactions" asp-route-id="@bank.Id" class="btn btn-xs btn-outline-info" title="Hareketler">
                                            <i class="fas fa-list-ul"></i>
                                        </a>
                                        <form asp-action="DeleteBank" method="post" style="display:inline;">
                                            <input type="hidden" name="id" value="@bank.Id" />
                                            <button type="submit" class="btn btn-xs btn-outline-danger" onclick="return confirm('Silmek istediğine emin misin?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-warning card-outline shadow-sm h-100">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-credit-card mr-1"></i> Şirket Kredi Kartları</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool bg-warning text-dark btn-sm" data-bs-toggle="modal" data-bs-target="#modalAddCard">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0 table-responsive" style="max-height: 300px;">
                <table class="table table-striped table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Kart Adı</th>
                            <th>Bağlı Banka</th>
                            <th style="width: 80px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var card in Model.BankCards)
                        {
                            <tr>
                                <td class="align-middle fw-bold">@card.CardName</td>
                                <td class="align-middle">
                                    @{
                                        var linkedBank = Model.Banks.FirstOrDefault(b => b.Id == card.BankId);
                                        <span class="badge bg-secondary">@(linkedBank != null ? linkedBank.BankName : "-")</span>
                                    }
                                </td>
                                <td class="align-middle text-right">
                                    <div class="btn-group">
                                        <a asp-action="CardTransactions" asp-route-id="@card.Id" class="btn btn-xs btn-outline-info" title="Ekstre">
                                            <i class="fas fa-file-invoice"></i>
                                        </a>
                                        <form asp-action="DeleteCard" method="post" style="display:inline;">
                                            <input type="hidden" name="id" value="@card.Id" />
                                            <button type="submit" class="btn btn-xs btn-outline-danger" onclick="return confirm('Silmek istediğine emin misin?')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card card-purple card-outline shadow-sm">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-calculator mr-1"></i> Sanal / Fiziki POS Cihazları</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool bg-purple text-white btn-sm" data-bs-toggle="modal" data-bs-target="#modalAddPos">
                        <i class="fas fa-plus"></i> Yeni POS Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="bg-light">
                        <tr>
                            <th>POS Adı</th>
                            <th>Bağlı Banka</th>
                            <th>Komisyon / Vade</th>
                            <th class="text-right text-warning">Blokede Bekleyen</th>
                            <th class="text-right text-success">Son 30 Gün Ciro</th>
                            <th style="width: 100px;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.PosTerminals != null)
                        {
                            @foreach (var pos in Model.PosTerminals)
                            {
                                <tr>
                                    <td class="font-weight-bold">@pos.Name</td>
                                    <td>@pos.BankName</td>
                                    <td>
                                        <div class="small text-muted">Komisyon: <span class="text-dark fw-bold">%@pos.CommissionRate.ToString("N2")</span></div>
                                        <div class="small text-muted">Vade: <span class="text-dark fw-bold">@pos.MaturityDays Gün</span></div>
                                    </td>
                                    <td class="text-right">
                                        @if (pos.BlockedBalance > 0)
                                        {
                                            <h6 class="text-warning fw-bold mb-0">@pos.BlockedBalance.ToString("C2")</h6>
                                            <small class="text-muted"><i class="fas fa-clock mr-1"></i>Hesaba Geçecek</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-right">
                                        <h6 class="text-success fw-bold mb-0">@pos.LastMonthTurnover.ToString("C2")</h6>
                                    </td>
                                    <td class="text-right">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-xs btn-outline-warning" data-bs-toggle="modal" data-bs-target="#modalEditPos-@pos.Id">
                                                <i class="fas fa-pen"></i>
                                            </button>
                                            <form asp-action="DeletePosTerminal" method="post" style="display:inline;">
                                                <input type="hidden" name="id" value="@pos.Id" />
                                                <button type="submit" class="btn btn-xs btn-outline-danger" onclick="return confirm('Silmek istediğine emin misin?')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                <div class="modal fade" id="modalEditPos-@pos.Id" tabindex="-1">
                                    @await Component.InvokeAsync("_EditPosTerminalViewComponentPartial", pos.Id)
                                </div>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card card-secondary card-outline shadow-sm mb-4">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-chart-line mr-1"></i> Son 6 Ay Gelir/Gider Analizi</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart">
                    <canvas id="revenueChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header border-0 d-flex justify-content-between align-items-center bg-light">
                <h3 class="card-title"><i class="fas fa-history mr-1"></i> Son Kasa Hareketleri</h3>

                <form asp-action="Index" method="get" class="d-flex align-items-center ml-auto">
                    <div class="input-group input-group-sm" style="width: 350px;">
                        <input type="date" name="startDate" class="form-control" value="@startVal" placeholder="Başlangıç">
                        <input type="date" name="endDate" class="form-control" value="@endVal" placeholder="Bitiş">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-filter"></i>
                        </button>
                        <a href="/Treasury/Index" class="btn btn-secondary" title="Filtreyi Temizle">
                            <i class="fas fa-sync"></i>
                        </a>
                    </div>
                </form>
            </div>

            <div class="card-body table-responsive p-0">
                <table class="table table-striped table-hover table-valign-middle">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Açıklama</th>
                            <th>Yapan</th>
                            <th>Kaynak</th>
                            <th class="text-right">Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Transactions)
                        {
                            <tr>
                                <td><i class="far fa-calendar-alt text-muted mr-1"></i> @item.TransactionDate.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@item.Description</td>
                                <td><span class="badge bg-light text-dark border">@item.AuthorName</span></td>
                                <td>
                                    @if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.Cash)
                                    {
                                        <span class="badge bg-success"><i class="fas fa-money-bill-wave mr-1"></i> Nakit</span>
                                    }
                                    else if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.Bank)
                                    {
                                        <span class="badge bg-primary"><i class="fas fa-university mr-1"></i> Banka</span>
                                    }
                                    else if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.CreditCard)
                                    {
                                        <span class="badge bg-info"><i class="fas fa-credit-card mr-1"></i> K.Kartı</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning text-dark">Veresiye</span>
                                    }
                                </td>
                                <td class="text-right font-weight-bold @(item.TransactionType == OtoTamir.CORE.Entities.TransactionType.Incoming ? "text-success" : "text-danger")">
                                    @(item.TransactionType == OtoTamir.CORE.Entities.TransactionType.Incoming ? "+" : "-") @item.Amount.ToString("C2")
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddBank" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddBankViewComponentPartial")
</div>

<div class="modal fade" id="modalAddCard" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddBankCardViewComponentPartial")
</div>

<div class="modal fade" id="modalAddPos" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddPosTerminalViewComponentPartial")
</div>
<div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddExpenseViewComponentPartial")
</div>


<script>
    
    function toggleExpenseFields() {
        var source = document.getElementById("expenseSourceSelect").value;
        var bankDiv = document.getElementById("bankSelectDiv");
        var cardDiv = document.getElementById("cardSelectDiv");

        if(bankDiv && cardDiv){
            bankDiv.classList.add("d-none");
            cardDiv.classList.add("d-none");

            if (source == "1") { 
                bankDiv.classList.remove("d-none");
            } else if (source == "2") {
                cardDiv.classList.remove("d-none");
            }
        }
    }
</script>