@model TreasuryDashboardDTO
@{
    ViewData["Title"] = "Kasa ve Banka Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Filtreleme için varsayılan tarihleri alıyoruz (Controller'dan ViewBag ile gelmezse bugünü baz al)
    var startVal = Context.Request.Query["startDate"].ToString();
    var endVal = Context.Request.Query["endDate"].ToString();
}

<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>@Model.Treasury.CashBalance.ToString("C2")</h3>
                <p>Nakit Kasa (Elden)</p>
            </div>
            <div class="icon"><i class="fas fa-wallet"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>@Model.Treasury.BankBalance.ToString("C2")</h3>
                <p>Toplam Banka Varlığı</p>
            </div>
            <div class="icon"><i class="fas fa-university"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner text-white">
                <h3 class="text-white">@Model.Treasury.ReceivablesBalance.ToString("C2")</h3>
                <p>Toplam Alacak (Veresiye)</p>
            </div>
            <div class="icon"><i class="fas fa-book-open"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-secondary">
            <div class="inner">
                <h3>@((Model.Treasury.CashBalance + Model.Treasury.BankBalance).ToString("C2"))</h3>
                <p>Toplam Hazır Değer</p>
            </div>
            <div class="icon"><i class="fas fa-chart-pie"></i></div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-university mr-1"></i> Banka Hesapları</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-bs-toggle="modal" data-bs-target="#modalAddBank">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Banka Adı</th>
                            <th>IBAN</th>
                            <th class="text-right">Bakiye</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bank in Model.Banks)
                        {
                            <tr>
                                <td>@bank.BankName</td>
                                <td><small>@bank.Iban</small></td>
                                <td class="text-right font-weight-bold">@bank.Balance.ToString("C2")</td>
                                <td class="text-right">
                                    <a asp-action="BankTransactions" asp-route-id="@bank.Id" class="btn btn-xs btn-info" title="Hareketler">
                                        <i class="fas fa-list-ul"></i>
                                    </a>

                                    <form asp-action="DeleteBank" method="post" style="display:inline;">
                                        <input type="hidden" name="id" value="@bank.Id" />
                                        <button type="submit" class="btn btn-xs btn-danger" onclick="return confirm('Silmek istediğine emin misin?')"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-warning card-outline">
            <div class="card-header">
                <h3 class="card-title"><i class="fas fa-credit-card mr-1"></i> POS / Kredi Kartları</h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-bs-toggle="modal" data-bs-target="#modalAddCard">
                        <i class="fas fa-plus"></i> Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Kart Adı</th>
                            <th>Bağlı Banka</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var card in Model.BankCards)
                        {
                            <tr>
                                <td>@card.CardName</td>
                                <td>
                                    @{
                                        var linkedBank = Model.Banks.FirstOrDefault(b => b.Id == card.BankId);
                                        <span>@(linkedBank != null ? linkedBank.BankName : "-")</span>
                                    }
                                </td>
                                <td class="text-right">
                                    <a asp-action="CardTransactions" asp-route-id="@card.Id" class="btn btn-xs btn-info" title="Ekstre/Hareketler">
                                        <i class="fas fa-list-ul"></i>
                                    </a>
                                    <form asp-action="DeleteCard" method="post" style="display:inline;">
                                        <input type="hidden" name="id" value="@card.Id" />
                                        <button type="submit" class="btn btn-xs btn-danger" onclick="return confirm('Silmek istediğine emin misin?')"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-12">
        <div class="card card-primary card-outline">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line mr-1"></i>
                    Son 6 Ay Gelir/Gider Analizi
                </h3>
                <div class="card-tools">
                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart">
                    <canvas id="revenueChart" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row"> ... </div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header border-0">
                <h3 class="card-title mt-2">Son Kasa Hareketleri</h3>

                <div class="card-tools">
                    <form asp-action="Index" method="get" class="form-inline">
                        <div class="input-group input-group-sm">
                            <input type="date" name="startDate" class="form-control" value="@startVal" placeholder="Başlangıç">
                            <input type="date" name="endDate" class="form-control ml-1" value="@endVal" placeholder="Bitiş">
                            <div class="input-group-append ml-1">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-filter"></i> Filtrele
                                </button>
                                <a href="/Treasury/Index" class="btn btn-default btn-sm ml-1">
                                    <i class="fas fa-sync"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card-body table-responsive p-0">
                <table class="table table-striped table-valign-middle">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Açıklama</th>
                            <th>Yapan</th>
                            <th>Kaynak</th>
                            <th class="text-right">Tutar</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Transactions)
                        {
                            <tr>
                                <td>@item.TransactionDate.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@item.Description</td>
                                <td>@item.AuthorName</td>
                                <td>
                                    @if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.Cash)
                                    {
                                        <span class="badge bg-success">Nakit</span>
                                    }
                                    else if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.Bank)
                                    {
                                        
                                        <span class="badge bg-primary">Banka</span>
                                    }
                                    else
                                    {
                                        
                                        <span class="badge bg-warning text-dark">Veresiye</span>
                                    }
                                </td>
                                <td class="text-right font-weight-bold @(item.TransactionType == OtoTamir.CORE.Entities.TransactionType.Incoming ? "text-success" : "text-danger")">
                                    @(item.TransactionType == OtoTamir.CORE.Entities.TransactionType.Incoming ? "+" : "-") @item.Amount.ToString("C2")
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddBank" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddBankViewComponentPartial")
</div>

<div class="modal fade" id="modalAddCard" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddBankCardViewComponentPartial")
</div>
@section Scripts {
    <script src="~/AdminLTE-master/plugins/chart.js/Chart.min.js"></script>

    <script>
        $(function () {
            // Backend'den gelen verileri JS değişkenlerine al
            // Html.Raw ve Json.Serialize kullanarak C# Listesini JS Array'ine çeviriyoruz
            var labels = @Html.Raw(Json.Serialize(Model.ChartLabels));
            var incomeData = @Html.Raw(Json.Serialize(Model.IncomeData));
            var expenseData = @Html.Raw(Json.Serialize(Model.ExpenseData));

            var areaChartCanvas = $('#revenueChart').get(0).getContext('2d');

            var areaChartData = {
                labels  : labels,
                datasets: [
                    {
                        label               : 'Gelirler (Tahsilat)',
                        backgroundColor     : 'rgba(40, 167, 69, 0.9)', // Yeşil
                        borderColor         : 'rgba(40, 167, 69, 0.8)',
                        pointRadius          : false,
                        pointColor          : '#28a745',
                        pointStrokeColor    : 'rgba(40, 167, 69, 1)',
                        pointHighlightFill  : '#fff',
                        pointHighlightStroke: 'rgba(40, 167, 69, 1)',
                        data                : incomeData
                    },
                    {
                        label               : 'Giderler (Harcama)',
                        backgroundColor     : 'rgba(220, 53, 69, 0.9)', // Kırmızı
                        borderColor         : 'rgba(220, 53, 69, 0.8)',
                        pointRadius         : false,
                        pointColor          : 'rgba(220, 53, 69, 1)',
                        pointStrokeColor    : '#c1c7d1',
                        pointHighlightFill  : '#fff',
                        pointHighlightStroke: 'rgba(220, 220, 220, 1)',
                        data                : expenseData
                    }
                ]
            }

            var areaChartOptions = {
                maintainAspectRatio : false,
                responsive : true,
                legend: {
                    display: true
                },
                scales: {
                    xAxes: [{
                        gridLines : {
                            display : false,
                        }
                    }],
                    yAxes: [{
                        gridLines : {
                            display : true,
                        },
                        ticks: {
                            beginAtZero: true,
                            callback: function(value, index, values) {
                                return value.toLocaleString("tr-TR") + ' ₺'; // TL Simgesi ekle
                            }
                        }
                    }]
                }
            }

            // Grafiği Çiz
            new Chart(areaChartCanvas, {
                type: 'bar', // Çizgi grafik istersen 'line' yapabilirsin
                data: areaChartData,
                options: areaChartOptions
            });
        });
    </script>
}