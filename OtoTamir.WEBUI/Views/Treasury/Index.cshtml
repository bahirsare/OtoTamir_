@model TreasuryDashboardDTO
@{
    ViewData["Title"] = "Kasa ve Banka Yönetimi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="row mb-3">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-success shadow-sm">
            <div class="inner">
                <h3>@Model.Treasury.CashBalance.ToString("C2")</h3>
                <p>Nakit Kasa</p>
            </div>
            <div class="icon"><i class="bi bi-wallet-fill"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info shadow-sm">
            <div class="inner">
                <h3>@Model.Treasury.BankBalance.ToString("C2")</h3>
                <p>Banka Varlığı</p>
            </div>
            <div class="icon"><i class="bi bi-bank2"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning shadow-sm">
            <div class="inner text-white">
                <h3 class="text-white">@Model.Treasury.ReceivablesBalance.ToString("C2")</h3>
                <p>Alacaklar</p>
            </div>
            <div class="icon"><i class="bi bi-journal-text"></i></div>
        </div>
    </div>
    <div class="col-lg-3 col-6">
        <div class="small-box bg-secondary shadow-sm">
            <div class="inner">
                <h3>@((Model.Treasury.CashBalance + Model.Treasury.BankBalance).ToString("C2"))</h3>
                <p>Hazır Değer</p>
            </div>
            <div class="icon"><i class="bi bi-pie-chart-fill"></i></div>
        </div>
    </div>
</div>

@await Component.InvokeAsync("_QuickActionsViewComponentPartial")

<div class="row">
<div class="row">
    <div class="col-lg-12 col-xl-5 mb-4">
        <div class="card card-primary card-outline shadow-sm h-100">
            <div class="card-header d-flex align-items-center py-2">
                <h3 class="card-title m-0"><i class="bi bi-bank me-1"></i> Banka Hesapları</h3>
                <div class="ms-auto">
                    <button type="button" class="btn btn-primary btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAddBank">
                        <i class="bi bi-plus-lg"></i> Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0 table-responsive" style="max-height: 350px;">
                <table class="table table-striped table-hover mb-0">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th>Banka / IBAN</th>
                            <th class="text-right">Bakiye</th>
                            <th class="text-center" style="width: 100px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bank in Model.Banks)
                        {
                            <tr>
                                <td class="align-middle">
                                    <div class="fw-bold text-primary">@bank.BankName</div>
                                    <div class="small text-muted">@bank.Iban</div>
                                </td>
                                <td class="align-middle text-right font-weight-bold">@bank.Balance.ToString("C2")</td>
                                <td class="align-middle text-center">
                                    <div class="d-flex gap-1 justify-content-center">
                                        <a asp-action="BankTransactions" asp-route-id="@bank.Id" class="btn btn-info text-white btn-sm shadow-sm py-1 px-2" title="Detay">
                                            <i class="bi bi-list-task"></i>
                                        </a>
                                        <form asp-action="DeleteBank" method="post">
                                            <input type="hidden" name="id" value="@bank.Id" />
                                                <button type="submit" class="btn btn-danger btn-sm shadow-sm py-1 px-2" title="Sil" onclick="return confirm('Silmek istediğine emin misin?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-12 col-xl-7 mb-4">
        <div class="card card-warning card-outline shadow-sm h-100">
            <div class="card-header d-flex align-items-center py-2">
                <h3 class="card-title m-0"><i class="bi bi-credit-card-2-front me-1"></i> Şirket Kredi Kartları</h3>
                <div class="ms-auto">
                    <button type="button" class="btn btn-warning text-dark btn-sm shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAddCard">
                        <i class="bi bi-plus-lg"></i> Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0 table-responsive" style="max-height: 350px;">
                <table class="table table-striped table-hover mb-0">
                    <thead class="bg-light sticky-top">
                        <tr>
                            <th>Kart Bilgisi</th>
                            <th>Durum (Limit/Borç)</th>
                            <th class="text-center">Kritik Tarih</th>
                            <th class="text-center" style="width: 100px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var card in Model.BankCards)
                        {

                                var barColor = card.UsagePercent > 80 ? "bg-danger" : (card.UsagePercent > 50 ? "bg-warning" : "bg-success");
                                var alertClass = card.IsAlert ? "text-danger fw-bold" : "text-dark";

                                <tr>
                                    <td class="align-middle">
                                        <div class="fw-bold">@card.CardName</div>
                                        <div class="small text-muted"><i class="bi bi-bank2 me-1"></i>@card.BankName</div>
                                    </td>
                                    <td class="align-middle" style="min-width: 140px;">
                                        <div class="d-flex justify-content-between small mb-1">
                                            <span>Borç: <span class="text-danger fw-bold">@card.Debt.ToString("C0")</span></span>
                                            <span>Limit: @card.Limit.ToString("C0")</span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar @barColor" role="progressbar" style="width: @card.UsagePercent.ToString("0")%" aria-valuenow="@card.UsagePercent" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <div class="small text-success mt-1 text-end">Kalan: @card.RemainingLimit.ToString("C0")</div>
                                    </td>
                                    <td class="align-middle text-center">
                                        <div class="@alertClass">@card.CriticalDateDisplay</div>
                                        <div class="badge bg-light text-dark border">@card.DateLabel</div>
                                    </td>
                                    <td class="align-middle text-center">
                                        <div class="d-flex gap-1 justify-content-center">
                                            <button type="button" class="btn btn-success btn-sm..." onclick="setPayModal('@card.Id', '@card.CardName')">
                                                <i class="bi bi-wallet2"></i>
                                            </button>
                                            <a asp-action="CardTransactions" asp-route-id="@card.Id" class="btn btn-info text-white btn-sm...">
                                                <i class="bi bi-receipt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card card-purple card-outline shadow-sm">
            <div class="card-header d-flex align-items-center py-2">
                <h3 class="card-title m-0"><i class="bi bi-calculator me-1"></i> Sanal / Fiziki POS Cihazları</h3>
                <div class="ms-auto">
                    <button type="button" class="btn btn-sm text-white shadow-sm" style="background-color: #6f42c1;" data-bs-toggle="modal" data-bs-target="#modalAddPos">
                        <i class="bi bi-plus-lg me-1"></i> Yeni POS Ekle
                    </button>
                </div>
            </div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>POS Adı / Banka</th>
                            <th>Komisyon / Vade</th>
                            <th class="text-end">Blokede Bekleyen</th>
                            <th class="text-end">Aylık Durum (Son 30 Gün)</th>
                            <th class="text-center" style="width: 100px;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.PosTerminals != null)
                        {
                            @foreach (var pos in Model.PosTerminals)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-bold">@pos.Name</div>
                                        <div class="small text-muted">@pos.BankName</div>
                                    </td>
                                    <td>
                                        <div class="small"><span class="text-muted">Kom:</span> <span class="fw-bold">%@pos.CommissionRate.ToString("N2")</span></div>
                                        <div class="small"><span class="text-muted">Vade:</span> <span class="fw-bold">@pos.MaturityDays Gün</span></div>
                                    </td>
                                    <td class="text-end">
                                        @if (pos.BlockedBalance > 0)
                                        {
                                            <h6 class="text-warning fw-bold mb-0">@pos.BlockedBalance.ToString("C2")</h6>
                                            <span class="badge bg-light text-dark border small mt-1">@pos.BlockedTransactionCount Adet İşlem</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <h6 class="text-success fw-bold mb-0">@pos.LastMonthTurnover.ToString("C2")</h6>
                                        <span class="badge bg-light text-success border small mt-1">Total: @pos.LastMonthTransactionCount İşlem</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex gap-1 justify-content-center">
                                            <button type="button" class="btn btn-warning text-dark btn-sm shadow-sm py-1 px-2" data-bs-toggle="modal" data-bs-target="#modalEditPos-@pos.Id">
                                                <i class="bi bi-pencil-square"></i>
                                            </button>
                                            <form asp-action="DeletePosTerminal" method="post">
                                                <input type="hidden" name="id" value="@pos.Id" />
                                                <button type="submit" class="btn btn-danger btn-sm shadow-sm py-1 px-2" onclick="return confirm('Silmek istediğine emin misin?')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header border-0 bg-light">
                <div class="row align-items-center">
                    <div class="col-md-3 mb-2 mb-md-0">
                        <h3 class="card-title"><i class="bi bi-clock-history me-1"></i> Son Kasa Hareketleri</h3>
                    </div>

                    <div class="col-md-9">
                        <form asp-action="Index" method="get">
                            <div class="row g-2 justify-content-md-end">
                                <div class="col-auto">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-white text-muted">Tarih</span>
                                        <input type="date" name="startDate" class="form-control" value="@ViewBag.StartDate">
                                        <input type="date" name="endDate" class="form-control" value="@ViewBag.EndDate">
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <select name="typeId" class="form-select form-select-sm">
                                        <option value="">Tüm İşlemler</option>
                                        <option value="0" selected="@(ViewBag.SelectedType == 0)">Para Girişi (+)</option>
                                        <option value="1" selected="@(ViewBag.SelectedType == 1)">Para Çıkışı (-)</option>
                                    </select>
                                </div>
                                   

                                    <div class="col-auto">
                                        <select name="sourceId" class="form-select form-select-sm">
                                            <option value="">Tüm Kaynaklar</option>
                                            <option value="0" selected="@(ViewBag.SelectedSource == 0)">Nakit (Kasa)</option>
                                            <option value="1" selected="@(ViewBag.SelectedSource == 1)">Banka</option>
                                            <option value="2" selected="@(ViewBag.SelectedSource == 2)">Veresiye</option>
                                            <option value="3" selected="@(ViewBag.SelectedSource == 3)">Kredi Kartı</option>
                                        </select>
                                    </div>

                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-primary btn-sm px-3 shadow-sm me-1">
                                            <i class="bi bi-funnel"></i> Filtrele
                                        </button>

                                        <button type="submit" asp-action="ExportToExcel" formmethod="get" class="btn btn-success btn-sm px-3 shadow-sm" title="Excel Olarak İndir">
                                            <i class="bi bi-file-earmark-excel"></i> Excel
                                        </button>

                                        <a href="/Treasury/Index" class="btn btn-outline-secondary btn-sm shadow-sm ms-1">
                                            <i class="bi bi-x-lg"></i> Temizle
                                        </a>
                                    </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card-body table-responsive p-0">
                @if (Model.Transactions == null || Model.Transactions.Count == 0)
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-search" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Kayıt Bulunamadı</h5>
                        <p class="mb-0">Seçilen kriterlere uygun kasa hareketi yok.</p>
                    </div>
                }
                else
                {
                    <table class="table table-striped table-hover table-valign-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Tarih</th>
                                <th>Açıklama</th>
                                <th>Yapan</th>
                                <th>Kategori</th>
                                <th>Kaynak</th>
                                <th class="text-right">Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Transactions)
                            {
                                <tr>
                                    <td class="text-nowrap">
                                        <i class="bi bi-calendar3 text-muted me-1"></i>
                                        @item.TransactionDate.ToString("dd.MM.yyyy HH:mm")
                                    </td>
                                    <td>
                                        <span class="fw-bold text-dark">@item.Description</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark border">@item.AuthorName</span>
                                    </td>
                                    <td>
                                        @if (item.TransactionCategory != null)
                                        {
                                            <span class="badge bg-info text-dark">@item.TransactionCategory.Name</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.Cash)
                                        {
                                            <span class="badge bg-success rounded-pill"><i class="bi bi-cash me-1"></i> Nakit</span>
                                        }
                                        else if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.Bank)
                                        {
                                            <span class="badge bg-primary rounded-pill"><i class="bi bi-bank me-1"></i> Banka</span>
                                        }
                                        else if (item.PaymentSource == OtoTamir.CORE.Entities.PaymentSource.CreditCard)
                                        {
                                            <span class="badge bg-secondary rounded-pill"><i class="bi bi-credit-card me-1"></i> Kart</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark rounded-pill">Veresiye</span>
                                        }
                                    </td>
                                    <td class="text-right font-weight-bold @(item.TransactionType == OtoTamir.CORE.Entities.TransactionType.Incoming ? "text-success" : "text-danger")">
                                        <i class="bi @(item.TransactionType == OtoTamir.CORE.Entities.TransactionType.Incoming ? "bi-arrow-up" : "bi-arrow-down") small me-1"></i>
                                        @Math.Abs(item.Amount).ToString("C2")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
            <partial name="_Pagination" model="ViewBag.PagedResult" />
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddBank" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddBankViewComponentPartial")
</div>
<div class="modal fade" id="modalAddCard" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddBankCardViewComponentPartial")
</div>
<div class="modal fade" id="modalAddPos" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_AddPosTerminalViewComponentPartial")
</div>

<div class="modal fade" id="payCardModal" tabindex="-1" aria-hidden="true">
    @await Component.InvokeAsync("_PayBankCardViewComponentPartial")
</div>


@if (Model.PosTerminals != null)
{
    @foreach (var pos in Model.PosTerminals)
    {
        <div class="modal fade" id="modalEditPos-@pos.Id" tabindex="-1">
            @await Component.InvokeAsync("_EditPosTerminalViewComponentPartial", pos.Id)
        </div>
    }
}
   

    <script>
        function setPayModal(id, name) {
            document.getElementById('payCardId').value = id;
            document.getElementById('payCardNameDisplay').innerText = name;
        }
    </script>
<script>
    function toggleExpenseFields() {
        var source = document.getElementById("expenseSourceSelect").value;
        var bankDiv = document.getElementById("bankSelectDiv");
        var cardDiv = document.getElementById("cardSelectDiv");

        if(bankDiv && cardDiv){
            bankDiv.classList.add("d-none");
            cardDiv.classList.add("d-none");

            if (source == "1") {
                bankDiv.classList.remove("d-none");
            } else if (source == "2") {
                cardDiv.classList.remove("d-none");
            }
        }
    }
</script>