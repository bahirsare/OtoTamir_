@model List<Client>
@{
    ViewData["Title"] = "Yeni İşlem Ekle";
    
}

<h2>Yeni İşlem Ekle</h2>

<div class="mb-3">
    <label for="clientSearch">Müşteri Ara:</label>
    <input type="text" class="form-control" id="clientSearch" placeholder="İsim veya telefon girin...">
</div>

<div id="clientList" class="list-group mb-4">
    @foreach (var client in Model)
    {
        <a href="#" class="list-group-item list-group-item-action" data-client-id="@client.Id">
            @client.Name - @client.PhoneNumber
        </a>
    }
</div>

<div id="vehicleSelection" style="display:none;">
    <h4>Müşterinin Araçları</h4>
    <div id="existingVehicles" class="mb-3">
        <!-- AJAX ile doldurulacak -->
    </div>

    <button class="btn btn-secondary mb-3" id="showNewVehicleForm">Yeni Araç Ekle</button>

    <form method="post" action="/Operation/SaveOperation">
        <input type="hidden" name="ClientId" id="clientId" />
        <input type="hidden" name="VehicleId" id="vehicleId" />

        <div id="newVehicleForm" style="display:none;">
            <div class="mb-3">
                <label>Plaka</label>
                <input type="text" class="form-control" name="Plate" />
            </div>
            <div class="mb-3">
                <label>Marka</label>
                <input type="text" class="form-control" name="Brand" />
            </div>
            <div class="mb-3">
                <label>Model</label>
                <input type="text" class="form-control" name="Model" />
            </div>
            <div class="mb-3">
                <label>Yıl</label>
                <input type="number" class="form-control" name="Year" />
            </div>
        </div>

        <div class="mb-3">
            <label>Şikayet</label>
            <textarea class="form-control" name="SymptomDescription" rows="3" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary">İşlemi Kaydet</button>
    </form>
</div>
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const clientLinks = document.querySelectorAll("#clientList a");
            const clientIdInput = document.getElementById("clientId");
            const vehicleSelection = document.getElementById("vehicleSelection");

            clientLinks.forEach(function (el) {
                el.addEventListener("click", function (e) {
                    e.preventDefault(); // sayfa yenilemesini engelle
                    const clientId = this.getAttribute("data-client-id");
                    clientIdInput.value = clientId;
                    vehicleSelection.style.display = "block";

                    // AJAX ile araçları getir
                    fetch(`/Operation/GetVehiclesByClient/${clientId}`)
                        .then(response => response.json())
                        .then(data => {
                            const container = document.getElementById("existingVehicles");
                            container.innerHTML = "";

                            if (data.length === 0) {
                                container.innerHTML = "<p>Kayıtlı araç bulunamadı.</p>";
                            } else {
                                data.forEach(vehicle => {
                                    const btn = document.createElement("button");
                                    btn.type = "button";
                                    btn.className = "btn btn-outline-primary me-2 mb-2";
                                    btn.textContent = vehicle.plate + " - " + vehicle.brand;
                                    btn.onclick = function () {
                                        document.getElementById("vehicleId").value = vehicle.id;
                                        document.getElementById("newVehicleForm").style.display = "none";
                                    };
                                    container.appendChild(btn);
                                });
                            }
                        });
                });
            });

            // Yeni araç ekleme formunu göster
            document.getElementById("showNewVehicleForm").addEventListener("click", function () {
                document.getElementById("newVehicleForm").style.display = "block";
                document.getElementById("vehicleId").value = "";
            });

            // Müşteri arama filtresi
            document.getElementById("clientSearch").addEventListener("input", function () {
                var search = this.value.toLowerCase();
                clientLinks.forEach(function (el) {
                    el.style.display = el.textContent.toLowerCase().includes(search) ? "block" : "none";
                });
            });
        });
    </script>
}