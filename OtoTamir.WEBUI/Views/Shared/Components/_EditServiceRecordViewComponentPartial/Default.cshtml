@model ServiceWorkflowLogDTO

<div class="modal-header bg-warning text-dark">
    <h5 class="modal-title">
        <i class="bi bi-tools me-2"></i> İşlem Güncelle / Tamamla
        <span class="badge bg-dark ms-2">@ViewBag.VehiclePlate</span>
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
</div>

<form asp-controller="ServiceRecord" asp-action="AddServiceWorkflowLogs" method="post">
    <div class="modal-body">
        <input type="hidden" asp-for="SymptomId" />
        <input type="hidden" asp-for="ReturnUrl" />
        <input type="hidden" name="AuthorName" value="@User.Identity.Name" /> <div class="row g-3 mb-3">
            <div class="col-md-12">
                <label asp-for="Status" class="form-label fw-bold">Semptom Durumu</label>
                <select asp-for="Status" class="form-select symptom-status-selector"
                        asp-items="Html.GetEnumSelectList<SymptomStatus>()">
                </select>
                <small class="text-muted">"Giderildi" seçerseniz işlem tamamlanmış sayılır ve ödeme ekranı açılır.</small>
            </div>

            <div class="col-md-12">
                <label asp-for="Content" class="form-label">Yapılan İşlem / Açıklama</label>
                <textarea asp-for="Content" class="form-control" rows="2" placeholder="Örn: Balatalar değişti, test sürüşü yapıldı..."></textarea>
                <span asp-validation-for="Content" class="text-danger"></span>
            </div>
        </div>

        <div class="p-3 border rounded bg-light mb-3">
            <h6 class="text-primary mb-3"><i class="bi bi-clock-history me-1"></i> Ek Süre & Maliyet (Opsiyonel)</h6>
            <div class="row g-2">
                <div class="col-6">
                    <label asp-for="AdditionalDays" class="form-label small">Ek Gün</label>
                    <input asp-for="AdditionalDays" type="number" class="form-control form-control-sm" placeholder="0" />
                </div>
                <div class="col-6">
                    <label asp-for="AdditionalCost" class="form-label small">Ek Ücret (TL)</label>
                    <input asp-for="AdditionalCost" type="number" class="form-control form-control-sm" placeholder="0.00" />
                </div>
            </div>
        </div>

        <div id="paymentSection" class="mt-3 p-3 border rounded bg-success-subtle d-none">
            <h6 class="text-success border-bottom border-success pb-2 mb-3">
                <i class="bi bi-wallet2 me-1"></i> Tahsilat Bilgileri
            </h6>

            <div class="row g-3">
                <div class="col-md-12">
                    <label class="form-label fw-bold">Ödeme Yöntemi</label>
                    <select asp-for="PaymentMethod" class="form-select payment-method-selector">
                        <option value="@PaymentSource.ClientBalance">Cari Hesaba Yaz (Borç)</option>
                        <option value="@PaymentSource.Cash">Nakit Tahsilat</option>
                        <option value="@PaymentSource.CreditCard">Kredi Kartı</option>
                        <option value="@PaymentSource.Bank">Banka Havalesi</option>
                    </select>
                </div>

                <div class="col-md-12 d-none bank-select-group">
                    <label class="form-label">Banka Hesabı</label>
                    <select asp-for="BankId" class="form-select">
                        <option value="">Seçiniz...</option>
                        @if (ViewBag.Banks != null)
                        {
                            foreach (var bank in ViewBag.Banks)
                            {
                                <option value="@bank.Id">@bank.BankName (@bank.Iban)</option>
                            }
                        }
                    </select>
                </div>

                <div class="col-md-12 d-none pos-select-group">
                    <label class="form-label">POS Cihazı</label>
                    <select name="PosTerminalId" class="form-select">
                        <option value="">Seçiniz...</option>
                        @if (ViewBag.PosTerminals != null)
                        {
                            foreach (var pos in ViewBag.PosTerminals)
                            {
                                <option value="@pos.Id">@pos.Name</option>
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="submit" class="btn btn-warning shadow-sm">
            <i class="bi bi-save me-1"></i> Kaydet ve Güncelle
        </button>
    </div>
</form>

<script>
    // 1. Semptom Giderildi (Fixed) seçilirse Ödemeyi Aç
    // SymptomStatus Enum: Pending=1, Fixed=2, NotFixed=3 (Kendi Enum sıranı kontrol et!)
    var statusSelect = document.querySelector('.symptom-status-selector');
    var paymentDiv = document.getElementById('paymentSection');

    if(statusSelect) {
        statusSelect.addEventListener('change', function() {
            // Eğer "Fixed" (2) seçilirse göster
            if (this.value === '2') {
                paymentDiv.classList.remove('d-none');
            } else {
                paymentDiv.classList.add('d-none');
            }
        });
    }

    // 2. Ödeme Yöntemi Değişimi (Banka/POS Gösterimi)
    var methodSelect = document.querySelector('.payment-method-selector');
    var bankGroup = document.querySelector('.bank-select-group');
    var posGroup = document.querySelector('.pos-select-group');

    if(methodSelect) {
        methodSelect.addEventListener('change', function() {
            bankGroup.classList.add('d-none');
            posGroup.classList.add('d-none');

            // CreditCard (2 veya string), Bank (3 veya string) - Enum değerine göre
            // EnumExtensions vs kullanmıyorsan value int gelir (0,1,2,3)
            if (this.value === 'CreditCard' || this.value === '2') {
                posGroup.classList.remove('d-none');
            }
            else if (this.value === 'Bank' || this.value === '3') {
                bankGroup.classList.remove('d-none');
            }
        });
    }
</script>