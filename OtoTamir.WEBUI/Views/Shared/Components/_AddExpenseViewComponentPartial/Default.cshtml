<div aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="expenseModalLabel">
                    <i class="fas fa-minus-circle mr-2"></i>Gider/Harcama Ekle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form asp-action="AddExpense" asp-controller="Treasury" method="post">
                <div class="modal-body">

                    <div class="form-group mb-3">
                        <label class="fw-bold">Tutar (TL)</label>
                        <div class="input-group">
                            <span class="input-group-text">₺</span>
                            <input type="text" name="Amount" class="form-control form-control-lg font-weight-bold" required placeholder="0.00" />
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="fw-bold">Kategori</label>
                        <div class="input-group">
                            <select name="CategoryId" id="categorySelect" class="form-control form-select">
                                <option value="">Genel (Kategorisiz)</option>
                                @if (ViewBag.Categories != null)
                                {
                                    foreach (var item in (List<OtoTamir.CORE.Entities.TransactionCategory>)ViewBag.Categories)
                                    {
                                        <option value="@item.Id">@item.Name</option>
                                    }
                                }
                            </select>
                            <button type="button" class="btn btn-outline-secondary" onclick="openAddCategoryModal()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="fw-bold">Açıklama</label>
                        <textarea name="Description" class="form-control" rows="2" required placeholder="Örn: Elektrik Faturası, Öğle Yemeği..."></textarea>
                    </div>

                    <div class="form-group mb-3">
                        <label class="fw-bold">Ödeme Kaynağı</label>
                        <select name="PaymentSource" id="expenseSourceSelect" class="form-control form-select" onchange="toggleExpenseFields()">
                            <option value="0">💵 Nakit (Kasa)</option>
                            <option value="1">🏦 Banka Hesabı</option>
                            <option value="2">💳 Kredi Kartı</option>
                        </select>
                    </div>

                    <div class="form-group mb-3 d-none bg-light p-2 rounded border" id="bankSelectDiv">
                        <label>Hangi Banka?</label>
                        <select name="BankId" class="form-control form-select">
                            <option value="">Seçiniz...</option>
                            @if (ViewBag.Banks != null)
                            {
                                foreach (var item in (List<OtoTamir.CORE.Entities.Bank>)ViewBag.Banks)
                                {
                                    <option value="@item.Id">@item.BankName (@item.Iban)</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="form-group mb-3 d-none bg-light p-2 rounded border" id="cardSelectDiv">
                        <label>Hangi Kart?</label>
                        <select name="BankCardId" class="form-control form-select">
                            <option value="">Seçiniz...</option>
                            @if (ViewBag.BankCards != null)
                            {
                                foreach (var item in (List<OtoTamir.CORE.Entities.BankCard>)ViewBag.BankCards)
                                {
                                    <option value="@item.Id">@item.CardName</option>
                                }
                            }
                        </select>
                    </div>

                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-danger px-4">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addCategoryModal" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Yeni Kategori</h6>
                <button type="button" class="btn-close" onclick="closeCategoryModal()"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="newCategoryName" class="form-control" placeholder="Kategori Adı Giriniz...">
            </div>
            <div class="modal-footer p-1">
                <button type="button" class="btn btn-primary btn-sm btn-block w-100" onclick="saveNewCategory()">Ekle</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Script: Kaynak Alanlarını Aç/Kapa
    function toggleExpenseFields() {
        var source = document.getElementById("expenseSourceSelect").value;
        var bankDiv = document.getElementById("bankSelectDiv");
        var cardDiv = document.getElementById("cardSelectDiv");

        bankDiv.classList.add("d-none");
        cardDiv.classList.add("d-none");

        if (source == "1") {
            bankDiv.classList.remove("d-none");
        } else if (source == "2") {
            cardDiv.classList.remove("d-none");
        }
    }

    // 2. Script: Küçük Modalı Açma
    // Bootstrap 5'te bir modal açıkken diğerini açmak bazen backdrop sorunu yapar.
    // En basiti ana modalı gizleyip diğerini açmak veya üstüne açmaktır.
    var expenseModalEl = document.getElementById('expenseModal');
    var categoryModalEl = document.getElementById('addCategoryModal');
    var categoryModal; // Bootstrap instance

    function openAddCategoryModal() {
        // Küçük modalı oluştur ve göster
        categoryModal = new bootstrap.Modal(categoryModalEl);
        categoryModal.show();
    }

    function closeCategoryModal() {
        if(categoryModal) categoryModal.hide();
    }

    // 3. Script: AJAX ile Kategori Kaydetme
    function saveNewCategory() {
        var name = document.getElementById("newCategoryName").value;
        if (!name) { alert("Lütfen isim girin."); return; }

        // Fetch API ile Controller'a istek atıyoruz
        fetch('/Treasury/AddCategoryAjax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Anti-Forgery Token gerekebilir, proje ayarlarına bağlı
            },
            body: JSON.stringify(name)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Başarılı!
                // 1. Selectbox'a yeni seçeneği ekle
                var select = document.getElementById("categorySelect");
                var option = document.createElement("option");
                option.value = data.id;
                option.text = data.name;
                option.selected = true; // Yeni ekleneni seçili yap
                select.add(option);

                // 2. Modalı kapat ve inputu temizle
                document.getElementById("newCategoryName").value = "";
                closeCategoryModal();
            } else {
                alert("Hata: " + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Bir hata oluştu.");
        });
    }
</script>