@model CreateSymptomGroupDTO

<form asp-action="CreateServiceRecord" asp-controller="ServiceRecord" method="post" class="border rounded shadow-sm p-3 mb-1 bg-light">

    <input type="hidden" asp-for="VehicleId" />
    <input type="hidden" asp-for="ReturnController" />
    <input type="hidden" asp-for="ReturnAction" />
    <input type="hidden" asp-for="ReturnId" />
    <div class="container-fluid">
        <div class="row align-items-start">
            <!-- Sol Taraf (Semptomlar için geniş alan) -->
            <div id="symptomContainer-@Model.VehicleId" class="col-md-8 pe-3" style="overflow-y: auto; max-height: 40vh;">
                <!-- JS ile semptomlar buraya eklenecek -->
            </div>

            <!-- Sağ Taraf (Yatay butonlar) -->
            <div class="col-md-4">
                <div class="d-flex flex-row gap-2 align-items-center p-2 bg-light rounded">
                    <!-- Yeni Semptom Ekle Butonu -->
                    <button type="button" class="btn btn-outline-secondary btn-sm flex-shrink-0"
                            onclick="addSymptomRow('symptomContainer-@Model.VehicleId')">
                        <i class="bi bi-plus-circle">Yeni Semptom Ekle</i>
                    </button>

                    <!-- Çalışan Input Grubu -->
                    <div class="d-flex align-items-center flex-grow-1">
                        <label asp-for="AuthorName" class="form-label fw-semibold me-2 mb-0">Çalışan:</label>
                        <input asp-for="AuthorName" class="form-control form-control-sm" style="min-width: 100px;" />
                    </div>

                    <!-- Kaydet Butonu -->
                    <button type="submit" class="btn btn-success btn-sm flex-shrink-0">
                        <i class="bi bi-check-circle">Kaydet</i>
                    </button>

                </div>
                <div class="d-flex flex-wrap gap-2 ms-auto mt-2">
                    <div style="width: 140px;">
                        <label class="form-label fw-semibold mb-1 d-block">Tamamlandı</label>
                        <div class="form-check">
                            <input type="checkbox"
                                   asp-for="IsCompleted"
                                   class="form-check-input symptom-complete-checkbox"
                                   data-index="@Model.VehicleId" />
                        </div>
                    </div>

                    <div style="width: 160px;">
                        <label class="form-label fw-semibold mb-1">Ödeme Yöntemi</label>

                        <select asp-for="PaymentMethod"
                                class="form-select form-select-sm payment-method"
                                data-index="@Model.VehicleId"
                                disabled>
                            <option value="">Seçiniz</option>
                            <option value="0">Nakit</option>
                            <option value="1">Banka</option>
                            <option value="2">Bakiye</option>
                        </select>

                        <div class="bank-selection-group mt-2"
                             data-index="@Model.VehicleId"
                             style="display: none;">
                            <label class="form-label fw-semibold mb-1">Banka</label>
                            <select asp-for="BankId" class="form-select form-select-sm">
                                <option value="">Seçiniz</option>
                                @if (ViewBag.Banks != null)
                                {
                                    foreach (var bank in ViewBag.Banks)
                                    {
                                        <option value="@bank.Id">@bank.BankName</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>
</form>
<script>
    // Sayfa iskeleti yüklendiğinde çalış (jQuery beklemez)
    document.addEventListener("DOMContentLoaded", function () {

        // İlk semptom satırını ekle
        if (typeof addSymptomRow === 'function') {
            try { addSymptomRow('symptomContainer-@Model.VehicleId'); } catch(e){}
        }

        // Tüm değişiklikleri dinleyen ana bekçi
        document.body.addEventListener("change", function (e) {

            // 1. TAMAMLANDI KUTUSU KONTROLÜ
            if (e.target.classList.contains("symptom-complete-checkbox")) {
                var index = e.target.getAttribute("data-index");
                var isChecked = e.target.checked;

                var paymentSelect = document.querySelector('.payment-method[data-index="' + index + '"]');

                if (paymentSelect) {
                    paymentSelect.disabled = !isChecked;

                    if (!isChecked) {
                        paymentSelect.value = "";
                        // Manuel tetikleme (Event dispatch)
                        var event = new Event('change', { bubbles: true });
                        paymentSelect.dispatchEvent(event);
                    }
                }
            }

            // 2. ÖDEME YÖNTEMİ KONTROLÜ
            if (e.target.classList.contains("payment-method")) {
                var index = e.target.getAttribute("data-index");
                var val = e.target.value;

                var bankGroup = document.querySelector('.bank-selection-group[data-index="' + index + '"]');

                if (bankGroup) {
                    if (val === "1") {
                        // AÇILMA KOMUTU (Kesin Çözüm)
                        // Bootstrap'in gizleme sınıfını siliyoruz
                        bankGroup.classList.remove("d-none");

                        // Tarayıcının itiraz edemeyeceği şekilde zorla açıyoruz
                        bankGroup.style.cssText = "display: block !important; opacity: 1 !important; visibility: visible !important;";
                    } else {
                        // KAPANMA KOMUTU
                        bankGroup.style.cssText = "display: none !important;";
                        bankGroup.classList.add("d-none");

                        // İçini temizle
                        var innerSelect = bankGroup.querySelector("select");
                        if(innerSelect) innerSelect.value = "";
                    }
                }
            }
        });
    });
</script>

