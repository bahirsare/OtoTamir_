@using Microsoft.AspNetCore.Routing
@model dynamic
@{
    var pagedResult = Model as dynamic;

    // 1. Controller ve Action bilgisini al
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();

    // 2. Temiz bir liste (RouteValueDictionary) oluşturuyoruz
    var routeValues = new RouteValueDictionary();

    // A) ÖNCE ROUTE DATA'YI AL (URL'deki /2 kısmı buradadır)
    // Bu işlem 'id'nin doğru (2) olarak alınmasını garantiler.
    foreach (var key in ViewContext.RouteData.Values.Keys)
    {
        routeValues[key] = ViewContext.RouteData.Values[key];
    }

    // B) SONRA QUERY STRING'İ AL (Filtreler)
    // AMA 'id' ve 'page' query string'den gelirse ALMA!
    foreach (var key in Context.Request.Query.Keys)
    {
        // KİLİT NOKTA BURASI: 'id' parametresini query string'den asla alma!
        // Zaten yukarıda RouteData'dan (A adımında) doğrusunu aldık.
        if (!key.Equals("page", StringComparison.OrdinalIgnoreCase) &&
            !key.Equals("id", StringComparison.OrdinalIgnoreCase))
        {
            routeValues[key] = Context.Request.Query[key];
        }
    }
}

@if (pagedResult != null && pagedResult.PageCount > 1)
{
    <div class="card-footer clearfix">
        <div class="float-left text-muted small">
            Toplam <strong>@pagedResult.RowCount</strong> kayıt, <strong>@pagedResult.PageCount</strong> sayfa.
        </div>

        <ul class="pagination pagination-sm m-0 float-right shadow-sm">

            @* ÖNCEKİ SAYFA *@
            <li class="page-item @(pagedResult.CurrentPage == 1 ? "disabled" : "")">
                @{
                    routeValues["page"] = pagedResult.CurrentPage - 1;
                }
                <a class="page-link" href="@Url.Action(currentAction, currentController, routeValues)">«</a>
            </li>

            @* SAYFA NUMARALARI *@
            @for (int i = 1; i <= pagedResult.PageCount; i++)
            {
                if (i == 1 || i == pagedResult.PageCount || (i >= pagedResult.CurrentPage - 2 && i <= pagedResult.CurrentPage + 2))
                {
                    <li class="page-item @(i == pagedResult.CurrentPage ? "active" : "")">
                        @{
                            routeValues["page"] = i;
                        }
                        <a class="page-link" href="@Url.Action(currentAction, currentController, routeValues)">@i</a>
                    </li>
                }
                else if (i == pagedResult.CurrentPage - 3 || i == pagedResult.CurrentPage + 3)
                {
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                }
            }

            @* SONRAKİ SAYFA *@
            <li class="page-item @(pagedResult.CurrentPage == pagedResult.PageCount ? "disabled" : "")">
                @{
                    routeValues["page"] = pagedResult.CurrentPage + 1;
                }
                <a class="page-link" href="@Url.Action(currentAction, currentController, routeValues)">»</a>
            </li>
        </ul>
    </div>
}